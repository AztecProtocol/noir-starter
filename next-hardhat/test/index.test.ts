// @ts-ignore
import { expect } from 'chai';
import ethers, { Contract } from 'ethers';
import path from 'path';
import { NoirNode } from '../utils/noir/noirNode';
import { execSync } from 'child_process';

const noir = new NoirNode();
import verifier from '../artifacts/circuits/contract/noirstarter/plonk_vk.sol/UltraVerifier.json';

import { test, beforeAll, describe } from 'vitest';

describe('It compiles noir program code, receiving circuit bytes and abi object.', () => {
  let verifierContract: Contract;
  let correctProof: any;
  let provider = ethers.getDefaultProvider('http://127.0.0.1:8545');
  let deployerWallet = new ethers.Wallet(
    process.env.DEPLOYER_PRIVATE_KEY as unknown as string,
    provider,
  );

  beforeAll(async () => {
    const Verifier = new ethers.ContractFactory(verifier.abi, verifier.bytecode, deployerWallet);
    verifierContract = await Verifier.deploy();

    const verifierAddr = await verifierContract.deployed();
    console.log(`Verifier deployed to ${verifierAddr.address}`);
  });

  it('Should generate valid proof for correct input', async () => {
    const arr = [
      '0x0000000000000000000000000000000000000000000000000000000000000083',
      '0x0000000000000000000000000000000000000000000000000000000000000018',
      '0x0000000000000000000000000000000000000000000000000000000000000053',
      '0x000000000000000000000000000000000000000000000000000000000000005b',
      '0x0000000000000000000000000000000000000000000000000000000000000054',
      '0x0000000000000000000000000000000000000000000000000000000000000010',
      '0x000000000000000000000000000000000000000000000000000000000000005d',
      '0x000000000000000000000000000000000000000000000000000000000000004a',
      '0x000000000000000000000000000000000000000000000000000000000000007a',
      '0x00000000000000000000000000000000000000000000000000000000000000ae',
      '0x0000000000000000000000000000000000000000000000000000000000000060',
      '0x00000000000000000000000000000000000000000000000000000000000000c0',
      '0x000000000000000000000000000000000000000000000000000000000000008f',
      '0x00000000000000000000000000000000000000000000000000000000000000c4',
      '0x000000000000000000000000000000000000000000000000000000000000005f',
      '0x0000000000000000000000000000000000000000000000000000000000000096',
      '0x0000000000000000000000000000000000000000000000000000000000000087',
      '0x0000000000000000000000000000000000000000000000000000000000000018',
      '0x000000000000000000000000000000000000000000000000000000000000001b',
      '0x000000000000000000000000000000000000000000000000000000000000004f',
      '0x00000000000000000000000000000000000000000000000000000000000000df',
      '0x00000000000000000000000000000000000000000000000000000000000000c6',
      '0x0000000000000000000000000000000000000000000000000000000000000025',
      '0x00000000000000000000000000000000000000000000000000000000000000bd',
      '0x000000000000000000000000000000000000000000000000000000000000001a',
      '0x0000000000000000000000000000000000000000000000000000000000000075',
      '0x000000000000000000000000000000000000000000000000000000000000003f',
      '0x00000000000000000000000000000000000000000000000000000000000000a7',
      '0x0000000000000000000000000000000000000000000000000000000000000039',
      '0x000000000000000000000000000000000000000000000000000000000000007f',
      '0x00000000000000000000000000000000000000000000000000000000000000ed',
      '0x0000000000000000000000000000000000000000000000000000000000000075',
      '0x0000000000000000000000000000000000000000000000000000000000000035',
      '0x0000000000000000000000000000000000000000000000000000000000000047',
      '0x00000000000000000000000000000000000000000000000000000000000000f1',
      '0x000000000000000000000000000000000000000000000000000000000000001c',
      '0x00000000000000000000000000000000000000000000000000000000000000a8',
      '0x0000000000000000000000000000000000000000000000000000000000000069',
      '0x0000000000000000000000000000000000000000000000000000000000000066',
      '0x0000000000000000000000000000000000000000000000000000000000000046',
      '0x00000000000000000000000000000000000000000000000000000000000000f2',
      '0x00000000000000000000000000000000000000000000000000000000000000f3',
      '0x00000000000000000000000000000000000000000000000000000000000000ac',
      '0x00000000000000000000000000000000000000000000000000000000000000b0',
      '0x000000000000000000000000000000000000000000000000000000000000008e',
      '0x0000000000000000000000000000000000000000000000000000000000000031',
      '0x0000000000000000000000000000000000000000000000000000000000000001',
      '0x000000000000000000000000000000000000000000000000000000000000006a',
      '0x00000000000000000000000000000000000000000000000000000000000000fa',
      '0x00000000000000000000000000000000000000000000000000000000000000c2',
      '0x000000000000000000000000000000000000000000000000000000000000003e',
      '0x0000000000000000000000000000000000000000000000000000000000000063',
      '0x000000000000000000000000000000000000000000000000000000000000000c',
      '0x000000000000000000000000000000000000000000000000000000000000005d',
      '0x0000000000000000000000000000000000000000000000000000000000000011',
      '0x00000000000000000000000000000000000000000000000000000000000000f5',
      '0x000000000000000000000000000000000000000000000000000000000000009f',
      '0x0000000000000000000000000000000000000000000000000000000000000061',
      '0x00000000000000000000000000000000000000000000000000000000000000fe',
      '0x00000000000000000000000000000000000000000000000000000000000000f5',
      '0x000000000000000000000000000000000000000000000000000000000000007b',
      '0x000000000000000000000000000000000000000000000000000000000000000d',
      '0x000000000000000000000000000000000000000000000000000000000000002a',
      '0x00000000000000000000000000000000000000000000000000000000000000a5',
      '0x0000000000000000000000000000000000000000000000000000000000000001',
      '0x0000000000000000000000000000000000000000000000000000000000000053',
      '0x0000000000000000000000000000000000000000000000000000000000000052',
      '0x00000000000000000000000000000000000000000000000000000000000000a7',
      '0x00000000000000000000000000000000000000000000000000000000000000b8',
      '0x000000000000000000000000000000000000000000000000000000000000004d',
      '0x00000000000000000000000000000000000000000000000000000000000000e2',
      '0x0000000000000000000000000000000000000000000000000000000000000068',
      '0x0000000000000000000000000000000000000000000000000000000000000005',
      '0x000000000000000000000000000000000000000000000000000000000000001b',
      '0x0000000000000000000000000000000000000000000000000000000000000097',
      '0x000000000000000000000000000000000000000000000000000000000000005b',
      '0x00000000000000000000000000000000000000000000000000000000000000ca',
      '0x000000000000000000000000000000000000000000000000000000000000007f',
      '0x0000000000000000000000000000000000000000000000000000000000000011',
      '0x00000000000000000000000000000000000000000000000000000000000000b7',
      '0x000000000000000000000000000000000000000000000000000000000000004b',
      '0x000000000000000000000000000000000000000000000000000000000000001f',
      '0x00000000000000000000000000000000000000000000000000000000000000be',
      '0x00000000000000000000000000000000000000000000000000000000000000fd',
      '0x000000000000000000000000000000000000000000000000000000000000009f',
      '0x0000000000000000000000000000000000000000000000000000000000000074',
      '0x000000000000000000000000000000000000000000000000000000000000009b',
      '0x000000000000000000000000000000000000000000000000000000000000000d',
      '0x0000000000000000000000000000000000000000000000000000000000000018',
      '0x00000000000000000000000000000000000000000000000000000000000000b2',
      '0x0000000000000000000000000000000000000000000000000000000000000028',
      '0x00000000000000000000000000000000000000000000000000000000000000a5',
      '0x0000000000000000000000000000000000000000000000000000000000000081',
      '0x000000000000000000000000000000000000000000000000000000000000005a',
      '0x0000000000000000000000000000000000000000000000000000000000000067',
      '0x00000000000000000000000000000000000000000000000000000000000000cc',
      '0x000000000000000000000000000000000000000000000000000000000000002a',
      '0x00000000000000000000000000000000000000000000000000000000000000a4',
      '0x00000000000000000000000000000000000000000000000000000000000000e6',
      '0x000000000000000000000000000000000000000000000000000000000000003e',
      '0x0000000000000000000000000000000000000000000000000000000000000049',
      '0x00000000000000000000000000000000000000000000000000000000000000b5',
      '0x00000000000000000000000000000000000000000000000000000000000000a9',
      '0x000000000000000000000000000000000000000000000000000000000000003d',
      '0x00000000000000000000000000000000000000000000000000000000000000fb',
      '0x00000000000000000000000000000000000000000000000000000000000000dd',
      '0x0000000000000000000000000000000000000000000000000000000000000080',
      '0x00000000000000000000000000000000000000000000000000000000000000dd',
      '0x000000000000000000000000000000000000000000000000000000000000000e',
      '0x0000000000000000000000000000000000000000000000000000000000000013',
      '0x00000000000000000000000000000000000000000000000000000000000000b3',
      '0x0000000000000000000000000000000000000000000000000000000000000019',
      '0x000000000000000000000000000000000000000000000000000000000000006b',
      '0x0000000000000000000000000000000000000000000000000000000000000084',
      '0x000000000000000000000000000000000000000000000000000000000000000a',
      '0x00000000000000000000000000000000000000000000000000000000000000bc',
      '0x0000000000000000000000000000000000000000000000000000000000000095',
      '0x0000000000000000000000000000000000000000000000000000000000000000',
      '0x00000000000000000000000000000000000000000000000000000000000000c5',
      '0x0000000000000000000000000000000000000000000000000000000000000034',
      '0x0000000000000000000000000000000000000000000000000000000000000097',
      '0x00000000000000000000000000000000000000000000000000000000000000ef',
      '0x00000000000000000000000000000000000000000000000000000000000000f4',
      '0x0000000000000000000000000000000000000000000000000000000000000067',
      '0x00000000000000000000000000000000000000000000000000000000000000d7',
      '0x00000000000000000000000000000000000000000000000000000000000000e0',
      '0x0000000000000000000000000000000000000000000000000000000000000038',
      '0x00000000000000000000000000000000000000000000000000000000000000f2',
      '0x0000000000000000000000000000000000000000000000000000000000000003',
      '0x0000000000000000000000000000000000000000000000000000000000000039',
      '0x00000000000000000000000000000000000000000000000000000000000000c7',
      '0x0000000000000000000000000000000000000000000000000000000000000060',
      '0x0000000000000000000000000000000000000000000000000000000000000091',
      '0x000000000000000000000000000000000000000000000000000000000000003a',
      '0x00000000000000000000000000000000000000000000000000000000000000b7',
      '0x00000000000000000000000000000000000000000000000000000000000000f1',
      '0x00000000000000000000000000000000000000000000000000000000000000ce',
      '0x000000000000000000000000000000000000000000000000000000000000008c',
      '0x0000000000000000000000000000000000000000000000000000000000000024',
      '0x0000000000000000000000000000000000000000000000000000000000000022',
      '0x00000000000000000000000000000000000000000000000000000000000000a5',
      '0x00000000000000000000000000000000000000000000000000000000000000a3',
      '0x0000000000000000000000000000000000000000000000000000000000000011',
      '0x00000000000000000000000000000000000000000000000000000000000000d2',
      '0x0000000000000000000000000000000000000000000000000000000000000061',
      '0x00000000000000000000000000000000000000000000000000000000000000fe',
      '0x000000000000000000000000000000000000000000000000000000000000009a',
      '0x000000000000000000000000000000000000000000000000000000000000004f',
      '0x000000000000000000000000000000000000000000000000000000000000005b',
      '0x00000000000000000000000000000000000000000000000000000000000000df',
      '0x0000000000000000000000000000000000000000000000000000000000000095',
      '0x0000000000000000000000000000000000000000000000000000000000000012',
      '0x0000000000000000000000000000000000000000000000000000000000000003',
      '0x00000000000000000000000000000000000000000000000000000000000000d2',
      '0x000000000000000000000000000000000000000000000000000000000000006f',
      '0x0000000000000000000000000000000000000000000000000000000000000038',
      '0x00000000000000000000000000000000000000000000000000000000000000f6',
      '0x00000000000000000000000000000000000000000000000000000000000000db',
      '0x0000000000000000000000000000000000000000000000000000000000000013',
      '0x0000000000000000000000000000000000000000000000000000000000000068',
    ];

    const userAbi = new Map<number, string>();

    for (let i = 0; i < arr.length; i++) {
      // @ts-ignore
      userAbi.set(i + 1, ethers.utils.hexZeroPad(arr[i], 32));
    }

    await noir.init();

    console.log(userAbi);
    const witness = await noir.generateWitness(userAbi);
    const proof = await noir.generateProof(witness);

    expect(proof instanceof Uint8Array).to.be.true;
    const verification = await noir.verifyProof(proof);
    expect(verification).to.be.true;

    const cutDownProof = '0x' + ethers.utils.hexlify(proof).slice(2);
    await verifierContract.verify(cutDownProof, []);
  });
});
